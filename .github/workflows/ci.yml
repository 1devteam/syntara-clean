name: CI
on:
  push: { branches: [ main, master ] }
  pull_request: { branches: [ main, master ] }

permissions:
  contents: write   # allow badge action to commit coverage badge

jobs:

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install (editable) + dev extras
        run: |
          python -m pip install -U pip wheel setuptools
          pip install -e ".[dev]"
      - name: Ruff
        run: ruff check .
      - name: Black (check)
        run: black --check .

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install (editable) + dev extras
        run: |
          python -m pip install -U pip wheel setuptools
          pip install -e ".[dev]"
      - name: Mypy
        run: mypy --config-file mypy.ini .

  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install (editable) + dev extras
        run: |
          python -m pip install -U pip wheel setuptools
          pip install -e ".[dev]" pytest-cov
      - name: Pytest with coverage (80% min)
        run: |
          pytest -q --cov=src/syntara --cov-report=term-missing --cov-report=xml --cov-fail-under=80
      - name: Generate coverage badge
        if: github.ref == 'refs/heads/main'
        uses: cicirello/coverage-badges-action@v3
        with:
          coverage-file: coverage.xml
          output: coverage-badges
      - name: Commit coverage badge
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -n "$(git status --porcelain coverage-badges)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add coverage-badges
            git commit -m "ci: update coverage badge"
            git push
          fi
      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: htmlcov
